# Content-Security-Policy

HTTP Content-Security-Policy 响应头允许网站管理员控制用户代理可以为给定页面加载的资源, 除了少数例外, 策略主要涉及指定服务器起点和脚本端点, 这有助于防止跨站点脚本攻击( [Cross-site_scripting](https://developer.mozilla.org/en-US/docs/Glossary/Cross-site_scripting) )

有关更多信息, 请参阅关于[内容安全策略( CSP )](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)的介绍性文章

- 头类型: [Response header](https://developer.mozilla.org/en-US/docs/Glossary/Response_header)
- 禁止的头名称: 无

## 语法

```
Content-Security-Policy: <policy-directive>; <policy-directive>
```

其中 **`<policy-directive>`** 包括: `<directive> <value>`，没有内部标点符号

## 指令

### 获取指令

获取指令控制加载某些资源类型的位置

- child-src: 为 web workers 和使用 `<frame>` 和 `<iframe>` 等元素加载的嵌套浏览上下文定义有效的源

> 如果想规范嵌套的浏览上下文和 workers, 应该分别使用 frame-src 和 worker-src 指令, 而不是 child-src

- connect-src: 限制可以通过脚本接口加载的 URLs
- default-src: 作为其他获取指令的后备
- font-src: 为使用 @font-face 加载的字体指定有效的源
- frame-src: 为使用 `<frame>` 和 `<iframe>` 等元素加载的嵌套浏览上下文指定有效的源
- img-src: 指定图像和图标的有效来源
- manifest-src: 指定应用程序清单文件的有效来源
- media-src: 指定使用 `<audio/>`, `<video/>` 和 `<track/>` 元素用于加载媒体的有效源
- object-src: 指定 `<object>`, `<embed>` 和 `<applet>` 元素的有效源

> 由 object-src 控制的元素可能碰巧被认为是遗留 HTML 元素, 并且没有接收新的标准化特性(例如 `<iframe/>` 的安全属性 sandbox 或 allow ), 因此, 建议限制这个 fetch-directive (例如, 如果可能, 显式设置 **object-src 'none'** )

- prefetch-src: 指定要预取或预呈现的有效源
- script-src: 指定 JavaScript 的有效源
- script-src-elem: 指定 JavaScript `<script>` 元素的有效源
- script-src-attr: 指定 JavaScript 内联事件处理程序的有效源
- style-src: 为样式表指定有效的源
- style-src-elem: 指定样式表 `<style>` 元素和带有 rel="stylesheet" 的 `<link/>` 元素的有效源
- style-src-attr: 指定应用于单个 DOM 元素的内联样式的有效源
- worker-src: 指定 Worker, SharedWorker 或 ServiceWorker 脚本的有效源

### 文档指令

文档指令控制策略应用到的文档或 worker 环境的属性

- base-uri: 限制可以在文档的 `<base>` 元素中使用的 URLs
- sandbox: 为请求的资源启用一个沙箱, 类似于 `<iframe>` sandbox 属性

### 导航指令

例如, 导航指令控制用户可以导航或提交表单的位置

- form-action: 限制可以用作从给定上下文提交表单的目标的 URLs
- frame-ancestors: 指定有效的父类, 可以使用 `<frame>`, `<iframe>`, `<object>`, `<embed>` 或 `<applet>` 嵌入页面
- navigate-to: 限制文档可以通过任何方式启动导航的 URLs, 包括 `<form>` (如果没有指定 form-action ), `<a/>`, window.location, window.open 等

### 报告指令

报告指令控制 CSP 违规的报告过程, 请参见 Content-Security-Policy-Report-Only 头

- report-to: 触发一个 SecurityPolicyViolationEvent

### 其它指令

- require-sri-for: 要求对页面上的脚本或样式使用 SRI
- require-trusted-types-for: 在 DOM XSS 注入接收器上强制[信任类型](https://w3c.github.io/webappsec-trusted-types/dist/spec/)
- trusted-types: 用于指定可信类型策略的允许列表, 受信任类型允许应用程序锁定 DOM XSS 注入接收器, 使其只接受不可欺骗的, 有类型的值, 而不是字符串
- upgrade-insecure-requests: 指示用户代理处理站点的所有不安全 URL (通过 HTTP 服务的 URL ), 就好像它们已经被安全 URL (通过 HTTPS 服务的 URL )取代了一样, 这个指令是针对有大量不安全的遗留 URL 需要重写的网站

## 值

### 关键字值

- none: 不允许加载任何资源
- self: 只允许来自当前来源的资源

### 不安全的关键字值

- unsafe-inline: 允许使用内联资源
- unsafe-eval: 允许使用动态代码求值, 如 eval, setImmediate 和 window.execScript

### 主机值

- Host:
  - 只允许从特定主机加载资源, 与可选方案, 端口和路径, 例如 `example.com`, `*.example.com`, `https://*.example.com:12/path/to/file.js`
  - CSP 中以 `/` 结尾的路径部分匹配其前缀为的任何路径, 例如 `example.com/api/` 将匹配像 `example.com/api/users/new` 这样的 URLs
  - CSP 中的其他路径部分是完全匹配的, 例如 `example.com/file.js` 将匹配 `http://example.com/file.js` 和 `https://example.com/file.js`, 但不匹配 `https://example.com/file.js/file2.js`
- Scheme:
  - 只允许在特定的模式上加载资源, 应该总是以 ":" 结尾, 例如 `https:`, `http:`, `data:` 等

### 其它值

- nonce-\*: 用于允许脚本的加密 nonce (只使用一次), 每次传输策略时, 服务器必须生成唯一的 nonce 值, 提供一个不能被猜到的 nonce 非常重要, 因为在其他情况下, 绕过资源的策略是微不足道的, 这与 script 标记 nonce 属性一起使用, 例如 nonce-DhcnhD3khTMePgXwdayK9BsMqXjhguVV
- `sha*-*`: sha256, sha384 或 sha512, 后跟一个破折号, 然后是 `sha*` 值, 例如 sha256-jzgBGA4UWFFmpOBq0JpdsySukE1FrEN5bUpoK8Z29fY=

## workers 中的 CSP

Workers 通常不受创建它们的文档(或父工作线程)的内容安全策略的控制, 要为 worker 指定一个内容安全策略, 为请求 worker 脚本本身的请求设置一个 Content-Security-Policy 响应头

例外情况是, 工作脚本的原点是全局唯一标识符(例如, 它的 URL 有一个数据或 blob 方案), 在这种情况下, 工作者继承文档或创建文档的工作者的内容安全策略

## 多种内容安全策略

CSP 机制允许为一个资源指定多个策略, 包括通过 Content-Security-Policy 头, Content-Security-Policy-Report-Only 头和 `<meta>` 元素

可以多次使用 Content-Security-Policy 头, 如下面的示例所示, 特别注意这里的 connect-src 指令, 尽管第二个策略允许连接, 但第一个策略包含 connect-src 'none', 添加额外的策略只能进一步限制受保护资源的功能, 这意味着不允许连接, 并强制执行最严格的策略 connect-src 'none'

```
Content-Security-Policy: default-src 'self' http://example.com;
                          connect-src 'none';
Content-Security-Policy: connect-src http://example.com/;
                          script-src http://example.com/
```

## 示例

示例: 禁用不安全的内联/eval, 只允许通过 https 加载资源(图像, 字体, 脚本等)

### 使用 HTTP 头

```
Content-Security-Policy: default-src https:
```

### 使用 HTML meta 元素

```html
<meta http-equiv="Content-Security-Policy" content="default-src https:">
```

例如: 现有的网站使用太多的内联代码来修复, 但希望确保资源只通过 HTTPS 加载, 并禁用插件

```
Content-Security-Policy: default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'
```

示例: 尚未实现上述策略, 相反, 只需报告可能发生的违规

```
Content-Security-Policy-Report-Only: default-src https:; report-uri /csp-violation-report-endpoint/
```

有关更多示例, 请参阅 [Mozilla Web 安全指南](https://infosec.mozilla.org/guidelines/web_security#Examples_5)

